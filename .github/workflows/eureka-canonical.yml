name: Eureka Canonical ‚Äî Restore + Validate + Self-Heal

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: eureka-canonical-main
  cancel-in-progress: true

jobs:
  canonicalize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch all branches
        run: |
          git fetch --all --prune

      - name: Ensure canonical folders
        run: |
          mkdir -p assets/images
          mkdir -p .github/workflows

      - name: Restore required files from any known branch (or self-heal)
        shell: bash
        run: |
          set +e

          # Branches a revisar (puedes agregar otros si usas m√°s)
          CANDIDATES=("upgrade-index" "main")

          # Helper: intenta traer un archivo desde cualquier branch candidato
          restore_from_any_branch () {
            local path="$1"
            if [ -f "$path" ]; then
              echo "‚úî Exists: $path"
              return 0
            fi

            for b in "${CANDIDATES[@]}"; do
              # Si el branch no existe, contin√∫a
              git show "origin/$b:$path" > "$path" 2>/dev/null
              if [ $? -eq 0 ]; then
                echo "üîÑ Restored $path from origin/$b"
                return 0
              else
                rm -f "$path" >/dev/null 2>&1
              fi
            done

            echo "‚ö† Could not restore $path from any branch"
            return 1
          }

          NEED_COMMIT=0

          # ---- Archivos requeridos ----
          for f in index.html patch-eureka.js patch-design.js seal-eureka.js style-editorial.css manifest.json; do
            restore_from_any_branch "$f"
            if [ ! -f "$f" ]; then
              echo "ü©π Creating minimal default: $f"
              NEED_COMMIT=1
              case "$f" in
                index.html)
                  cat > index.html << 'EOF'
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Didactic Eureka</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style-editorial.css">
</head>
<body>
  <main id="eureka-root"></main>
  <script src="boots.js"></script>
  <script src="patch-eureka.js"></script>
  <script src="patch-design.js"></script>
  <script src="seal-eureka.js"></script>
</body>
</html>
EOF
                  ;;
                patch-eureka.js)
                  cat > patch-eureka.js << 'EOF'
/* Minimal patch-eureka.js (self-healed). Replace with canonical version when available. */
console.log("patch-eureka.js loaded");
EOF
                  ;;
                patch-design.js)
                  cat > patch-design.js << 'EOF'
/* Minimal patch-design.js (self-healed). Replace with canonical version when available. */
(function(){ const s=document.createElement("style"); s.textContent="body{font-family:system-ui;margin:0} main{max-width:1000px;margin:0 auto;padding:2rem}"; document.head.appendChild(s);}());
EOF
                  ;;
                seal-eureka.js)
                  cat > seal-eureka.js << 'EOF'
/* Minimal seal-eureka.js (self-healed). */
(function(){ console.log("seal-eureka.js loaded"); }());
EOF
                  ;;
                style-editorial.css)
                  cat > style-editorial.css << 'EOF'
/* Minimal style-editorial.css (self-healed). */
body{background:#fff;color:#111}
EOF
                  ;;
                manifest.json)
                  cat > manifest.json << 'EOF'
{"name":"Didactic Eureka","short_name":"Eureka","start_url":"/didactic-eureka/","display":"standalone"}
EOF
                  ;;
              esac
            fi
          done

          # ---- Im√°genes can√≥nicas ----
          # Regla: assets/images/index.jpg (portada) y assets/images/1.png (publicidad)
          if [ ! -f "assets/images/index.jpg" ]; then
            # intenta restaurar desde branches
            restore_from_any_branch "assets/images/index.jpg"
            if [ ! -f "assets/images/index.jpg" ] && [ -f "index.jpg" ]; then
              echo "üîÑ Copying root index.jpg -> assets/images/index.jpg"
              cp -f index.jpg assets/images/index.jpg
              NEED_COMMIT=1
            fi
          fi

          if [ ! -f "assets/images/1.png" ]; then
            restore_from_any_branch "assets/images/1.png"
            if [ ! -f "assets/images/1.png" ] && [ -f "1.png" ]; then
              echo "üîÑ Copying root 1.png -> assets/images/1.png"
              cp -f 1.png assets/images/1.png
              NEED_COMMIT=1
            fi
          fi

          # Si a√∫n faltan, no fallamos: dejamos warning (sitio sigue vivo, pero sin imagen)
          if [ ! -f "assets/images/index.jpg" ]; then
            echo "‚ö† WARNING: Missing assets/images/index.jpg"
          fi
          if [ ! -f "assets/images/1.png" ]; then
            echo "‚ö† WARNING: Missing assets/images/1.png"
          fi

          # ---- Validaci√≥n final (solo de existencia de archivos n√∫cleo) ----
          REQUIRED=(index.html patch-eureka.js patch-design.js seal-eureka.js)
          for r in "${REQUIRED[@]}"; do
            if [ ! -f "$r" ]; then
              echo "‚ùå Still missing required file: $r"
              exit 1
            fi
          done

          # Detectar cambios
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            NEED_COMMIT=1
          fi

          if [ "$NEED_COMMIT" -eq 1 ]; then
            git config user.name "eureka-bot"
            git config user.email "actions@github.com"
            git add -A
            git commit -m "Canonicalize main [skip eureka]"
          else
            echo "‚úî No changes needed"
          fi

      - name: Push changes (if any)
        run: |
          # Si no hay commit nuevo, esto no hace nada
          git push origin main || true
