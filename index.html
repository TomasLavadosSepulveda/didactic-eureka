<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Didactic Eureka</title>

<style>
body{
  margin:0;
  font-family:Georgia,"Times New Roman",serif;
  background:#f6f5f2;
  color:#141;
}
header{
  position:sticky;
  top:0;
  z-index:10;
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:18px;
}
h1{
  margin:0;
  font-size:26px;
  font-weight:normal;
}
nav{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:12px;
}
nav button{
  background:#eaeaea;
  border:none;
  padding:8px 16px;
  border-radius:22px;
  cursor:pointer;
  font-size:16px;
}
nav button.active{
  background:#ccc;
}

main{
  display:grid;
  grid-template-columns: minmax(0,1fr) 320px;
  gap:28px;
  max-width:1200px;
  margin:auto;
  padding:24px;
}
@media(max-width:900px){
  main{grid-template-columns:1fr}
}

.section-title{
  font-size:24px;
  margin:0 0 16px 0;
}

.list-item{
  padding:10px 0;
  border-bottom:1px solid #ddd;
}
.list-item button{
  background:none;
  border:none;
  font-size:19px;
  cursor:pointer;
  text-align:left;
}
.list-item button:hover{
  color:#1f3cff;
}

.article iframe{
  width:100%;
  height:85vh;
  border:1px solid #ddd;
  border-radius:10px;
}

aside{
  border-left:1px solid #ddd;
  padding-left:18px;
}
aside h3{
  margin-top:0;
  font-weight:normal;
  font-size:18px;
}
aside button{
  display:block;
  background:none;
  border:none;
  padding:6px 0;
  font-size:16px;
  cursor:pointer;
  text-align:left;
}
aside button:hover{color:#1f3cff}
</style>
</head>
<script src="patch-eureka.js"></script>
<script src="patch-design.js"></script>
<!-- ==================================================
     ANCLA ETERNA DE PARCHES — DIDACTIC EUREKA
     No borrar. No mover.
     ================================================== -->

<script>
  /* Garantiza que los parches carguen SIEMPRE,
     incluso si el DOM se re-renderiza */
  window.__EUREKA_PATCHES__ = true;
</script>

<script src="./patch-eureka.js?v=eternal"></script>
<script src="./patch-design.js?v=eternal"></script>

<style>
  /* ===============================
     REPARACIÓN ESTRUCTURAL DE LECTURA
     =============================== */

  /* Evitar layout tipo visor */
  iframe,
  embed,
  object {
    display: block !important;
    width: 100% !important;
    height: 90vh !important;
    border: none !important;
    margin: 2rem auto !important;
  }

  /* Forzar lectura frontal */
  main {
    display: block !important;
  }

  article {
    max-width: 860px !important;
    margin: 0 auto !important;
    float: none !important;
  }

  /* Eliminar columnas laterales internas del artículo */
  article * {
    float: none !important;
  }
</style>

<body>

<header>
  <h1>Didactic Eureka</h1>
  <nav id="nav"></nav>
</header>

<main>
  <section id="content"></section>
  <aside id="sidebar"></aside>
</main>

<script>
/* ---------- UTILIDAD CLAVE (ARREGLA NOMBRES PEGADOS) ---------- */
function humanTitle(str){
  return str
    .replace(/\.pdf$/i,"")
    .replace(/[_\-]+/g," ")
    .replace(/([a-z])([A-Z])/g,"$1 $2")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase()
    .replace(/\b\w/g,c=>c.toUpperCase());
}

const BASE = location.origin + location.pathname.replace(/\/[^\/]*$/,"");
let MANIFEST = null;
let PATH = [];
let CURRENT_FILES = [];

/* ---------- NODO ACTUAL ---------- */
function nodeAtPath(){
  let n = MANIFEST;
  for(const p of PATH){ n = n.folders[p]; }
  return n;
}

/* ---------- NAV SUPERIOR ---------- */
function renderNav(){
  const nav=document.getElementById("nav");
  nav.innerHTML="";
  Object.keys(MANIFEST.folders||{}).forEach(cat=>{
    const b=document.createElement("button");
    b.textContent=humanTitle(cat.replace(/:$/,""));
    b.onclick=()=>{
      PATH=[cat];
      render();
    };
    nav.appendChild(b);
  });
}

/* ---------- RENDER PRINCIPAL ---------- */
function render(){
  const content=document.getElementById("content");
  const sidebar=document.getElementById("sidebar");
  content.innerHTML="";
  sidebar.innerHTML="";

  const node=nodeAtPath();
  CURRENT_FILES=node.files||[];

  content.innerHTML=`<h2 class="section-title">${humanTitle(PATH.at(-1)||"Inicio")}</h2>`;

  /* Subcarpetas */
  Object.keys(node.folders||{}).forEach(sub=>{
    const d=document.createElement("div");
    d.className="list-item";
    const b=document.createElement("button");
    b.textContent="▶ "+humanTitle(sub.replace(/:$/,""));
    b.onclick=()=>{
      PATH.push(sub);
      render();
    };
    d.appendChild(b);
    content.appendChild(d);
  });

  /* Artículos */
  CURRENT_FILES.forEach(file=>{
    const d=document.createElement("div");
    d.className="list-item";
    const b=document.createElement("button");
    b.textContent=humanTitle(file);
    b.onclick=()=>openArticle(file);
    d.appendChild(b);
    content.appendChild(d);
  });

  sidebar.innerHTML="<p>Selecciona un artículo para leerlo.</p>";
}

/* ---------- ARTÍCULO (NO LINK, SOLO LECTOR) ---------- */
function openArticle(file){
  const content=document.getElementById("content");
  const sidebar=document.getElementById("sidebar");
  const url=[...PATH,file].map(encodeURIComponent).join("/");

  content.innerHTML=`
    <h2 class="section-title">${humanTitle(file)}</h2>
    <div class="article">
      <iframe src="${url}#toolbar=0&navpanes=0"></iframe>
    </div>
  `;

  sidebar.innerHTML="<h3>En esta categoría</h3>";
  CURRENT_FILES.forEach(f=>{
    if(f!==file){
      const b=document.createElement("button");
      b.textContent=humanTitle(f);
      b.onclick=()=>openArticle(f);
      sidebar.appendChild(b);
    }
  });
}

/* ---------- INIT ---------- */
fetch("manifest.json",{cache:"no-store"})
.then(r=>r.json())
.then(m=>{
  MANIFEST=m;
  renderNav();
  render();
})
.catch(()=>{
  document.getElementById("content").innerHTML="Error cargando manifest.json";
});
</script>
<!-- ===============================
     ANCLA DEFINITIVA DIDACTIC EUREKA
     =============================== -->

<script>
  window.__EUREKA_ROOT__ = true;
</script>

<script src="patch-eureka.js"></script>
<script src="patch-design.js"></script>

</body>
  <main id="eureka-root">
  <!-- aquí se inyecta todo -->
</main>

</html>
