<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Didactic Eureka</title>

<style>
body{margin:0;font-family:Georgia,"Times New Roman",serif;background:#f6f5f2;color:#141}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd;padding:14px}
h1{margin:0 0 10px 0;font-size:22px;font-weight:normal;letter-spacing:.2px}
#crumbs{font-size:14px;color:#666;margin-top:8px}
#crumbs a{color:#1f3cff;text-decoration:none}
#crumbs a:hover{text-decoration:underline}

nav{display:flex;gap:8px;overflow-x:auto;padding-top:8px}
nav button{border:1px solid transparent;background:#eee;padding:6px 14px;border-radius:20px;cursor:pointer;white-space:nowrap}
nav button.active{background:#ccc}

main{max-width:900px;margin:auto;padding:20px}
.section-title{font-size:20px;margin:0 0 12px 0;font-weight:normal}
.item{padding:10px 0;border-bottom:1px solid #ddd}
.item button{background:none;border:none;color:#1f3cff;cursor:pointer;font-size:16px;text-align:left}
.item button:hover{text-decoration:underline}

.article img{max-width:100%;margin:12px 0 16px 0;border:1px solid #ddd;border-radius:10px}
.article iframe{width:100%;height:80vh;border:1px solid #ddd;border-radius:10px}
.note{color:#666;font-size:14px;margin-top:12px}
</style>
</head>

<body>

<header>
  <h1>Didactic Eureka</h1>
  <div id="crumbs"></div>
  <nav id="nav"></nav>
</header>

<main id="content">Cargando…</main>

<script>
/** Limpia nombre para mostrar: quita ":" solo al final, humaniza, separa */
function prettyLabel(raw){
  if(!raw) return "";
  // quita ":" al final y espacios extremos
  const cleaned = raw.replace(/:\s*$/,"").trim();

  // normaliza acentos y separadores
  return cleaned
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\.pdf$/i,"")
    .replace(/[_\-]+/g," ")
    .replace(/\s+/g," ")
    .trim()
    .toLowerCase()
    .replace(/\b\w/g, c => c.toUpperCase());
}

/** Construye URL segura por segmentos */
function joinUrlSegments(base, segments){
  const safe = segments.map(s => encodeURIComponent(s));
  return base.replace(/\/$/,"") + "/" + safe.join("/");
}

/** Base del sitio (para que funcione en /didactic-eureka/ y también en subpaths) */
const BASE = location.origin + location.pathname.replace(/\/[^\/]*$/,"").replace(/\/$/,"");

/** Estado de navegación */
let MANIFEST = null;
let pathStack = []; // nombres reales de carpetas (con ":" si existe)

const navEl = document.getElementById("nav");
const contentEl = document.getElementById("content");
const crumbsEl = document.getElementById("crumbs");

/** Devuelve el nodo del manifest correspondiente al pathStack */
function getNodeAtPath(){
  let node = MANIFEST;
  for(const seg of pathStack){
    if(!node.folders || !node.folders[seg]) return null;
    node = node.folders[seg];
  }
  return node;
}

/** Render breadcrumbs */
function renderCrumbs(){
  if(pathStack.length === 0){
    crumbsEl.innerHTML = `<span class="note">Navega por categorías y subcategorías.</span>`;
    return;
  }
  const parts = ['<a href="#" data-i="-1">Inicio</a>'];
  pathStack.forEach((seg, i) => {
    parts.push(`&nbsp;›&nbsp;<a href="#" data-i="${i}">${prettyLabel(seg)}</a>`);
  });
  crumbsEl.innerHTML = parts.join("");
  crumbsEl.querySelectorAll("a").forEach(a=>{
    a.addEventListener("click",(e)=>{
      e.preventDefault();
      const i = Number(a.dataset.i);
      if(i === -1) pathStack = [];
      else pathStack = pathStack.slice(0, i+1);
      renderView();
    });
  });
}

/** Render tabs for current node folders, and list PDFs if any */
function renderView(){
  const node = getNodeAtPath();
  renderCrumbs();

  if(!node){
    navEl.innerHTML = "";
    contentEl.innerHTML = `<p>Error: no se encontró esta ruta en manifest.</p>`;
    return;
  }

  // Tabs: todas las subcarpetas del nodo actual
  navEl.innerHTML = "";
  const folderEntries = Object.entries(node.folders || {});
  folderEntries.forEach(([folderName, folderNode], idx)=>{
    const btn = document.createElement("button");
    btn.textContent = prettyLabel(folderName);
    btn.addEventListener("click", ()=>{
      // al entrar a una carpeta, la hacemos el nuevo path
      pathStack.push(folderName);
      renderView();
    });
    navEl.appendChild(btn);
  });

  // Contenido: lista de PDFs del nodo actual
  const title = pathStack.length ? prettyLabel(pathStack[pathStack.length-1]) : "Inicio";
  contentEl.innerHTML = `<h2 class="section-title">${title}</h2>`;

  const files = node.files || [];
  if(files.length === 0){
    const msg = folderEntries.length
      ? "No hay PDFs en este nivel. Entra a una subcategoría."
      : "No hay contenido aquí todavía.";
    contentEl.innerHTML += `<p class="note">${msg}</p>`;
  } else {
    files.forEach(file=>{
      const row = document.createElement("div");
      row.className = "item";

      const btn = document.createElement("button");
      btn.textContent = prettyLabel(file);

      btn.addEventListener("click", ()=>{
        openArticle(file);
      });

      row.appendChild(btn);
      contentEl.appendChild(row);
    });
  }

  // Nota pequeña si hay subcarpetas
  if(folderEntries.length){
    contentEl.innerHTML += `<p class="note">Subcategorías: ${folderEntries.map(([n])=>prettyLabel(n)).join(" · ")}</p>`;
  }
}

/** Abre PDF en lector interno (sin descarga) */
function openArticle(file){
  const title = prettyLabel(file);

  // ruta real: BASE + pathStack (carpetas reales) + file
  const pdfUrl = joinUrlSegments(BASE, [...pathStack, file]);
  const imgUrlJpg = pdfUrl.replace(/\.pdf$/i, ".jpg");
  const imgUrlPng = pdfUrl.replace(/\.pdf$/i, ".png");

  contentEl.innerHTML = `
    <div class="article">
      <h2 class="section-title">${title}</h2>
      <img id="artimg" src="${imgUrlJpg}">
      <iframe src="${pdfUrl}" loading="lazy"></iframe>
      <p class="note">Si quieres imagen por artículo: sube <code>${file.replace(/\.pdf$/i,".jpg")}</code> o <code>${file.replace(/\.pdf$/i,".png")}</code> en la misma carpeta.</p>
    </div>
  `;

  // fallback jpg -> png -> ocultar
  const img = document.getElementById("artimg");
  img.onerror = () => {
    if(img.src.endsWith(".jpg")) img.src = imgUrlPng;
    else img.style.display = "none";
  };
}

/** Carga manifest */
fetch("manifest.json", {cache:"no-store"})
  .then(r=>r.json())
  .then(m=>{
    MANIFEST = m;
    pathStack = [];
    renderView();
  })
  .catch(err=>{
    console.error(err);
    contentEl.innerHTML = "<p>Error al cargar manifest.json</p>";
  });
</script>

</body>
</html>
