<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Didactic Eureka</title>
<meta name="description" content="Didactic Eureka · Navegación editorial por carpetas y artículos" />

<style>
:root{
  --bg:#f6f5f2; --paper:#fff; --ink:#141414; --muted:#666;
  --line:#e2e0d9; --accent:#1f3cff; --shadow:0 6px 18px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family: ui-serif, Georgia, "Times New Roman", serif;
  line-height:1.7;
}
.wrap{max-width:1180px;margin:auto;padding:0 22px}
header{
  position:sticky; top:0; z-index:20;
  background:var(--paper); border-bottom:1px solid var(--line);
}
.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:16px; padding:14px 0;
}
h1{margin:0;font-size:22px}
.brand{display:flex; align-items:center; gap:12px}
.breadcrumb{
  font-size:12px; color:var(--muted);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw;
}
.tabrow{
  display:flex; gap:8px;
  overflow-x:auto; white-space:nowrap;
  scrollbar-width:thin;
  padding:8px 0 12px;
}
.tabrow::-webkit-scrollbar{height:6px}
.tabrow::-webkit-scrollbar-thumb{background:#cfcfcf;border-radius:999px}
.tabrow button{
  background:none; border:1px solid transparent;
  font-family:inherit; font-size:13px;
  padding:6px 12px; border-radius:999px;
  cursor:pointer; flex:0 0 auto;
}
.tabrow button:hover{background:#efefe9}
.tabrow button.active{
  background:#efefe9; border-color:#e7e6df;
}
main{padding:18px 0 54px}
.hero{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:18px;
  overflow:hidden;
  box-shadow:var(--shadow);
  margin:18px 0;
}
.hero img{width:100%; display:block}
.hero .cap{padding:14px 16px; color:var(--muted); font-size:12px; border-top:1px solid var(--line)}
.panel{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:18px;
  padding:18px;
  box-shadow:var(--shadow);
}
.panel h2{margin:0 0 12px; font-size:20px}
.grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:14px;
}
@media (max-width: 820px){ .grid{grid-template-columns: 1fr;} }
.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:linear-gradient(180deg, #fff, #fbfbf8);
}
.card h3{margin:0 0 8px; font-size:16px}
.card p{margin:0 0 10px; color:var(--muted); font-size:12px}
.card button{
  background:var(--accent); color:#fff;
  border:none; border-radius:10px;
  padding:8px 12px; cursor:pointer;
}
.card button:hover{opacity:.92}
.thumb{
  width:100%;
  border:1px solid var(--line);
  border-radius:12px;
  margin:10px 0 12px;
  display:block;
}
.article{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:18px;
  padding:18px;
  box-shadow:var(--shadow);
}
.article h2{margin:0 0 10px; font-size:22px}
.article .meta{color:var(--muted); font-size:12px; margin-bottom:12px}
.pdfwrap{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}
.pdfbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding:10px 12px;
  background:#fbfbf8;
  border-bottom:1px solid var(--line);
  font-size:12px; color:var(--muted);
}
.pdfbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.pdfbar input{
  width:74px; padding:6px 8px; border-radius:10px;
  border:1px solid var(--line); font-size:12px;
}
.pdfbar button{
  background:none; border:1px solid var(--line);
  border-radius:10px; padding:6px 10px; cursor:pointer;
}
.pdfbar button:hover{background:#efefe9}
#pdfPages{padding:12px}
canvas{max-width:100%; display:block; margin:0 auto 14px; border-radius:12px; border:1px solid var(--line)}
footer{
  border-top:1px solid var(--line);
  padding:18px 0;
  text-align:center; color:var(--muted); font-size:12px;
}
small.note{color:var(--muted)}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Didactic Eureka</h1>
        <div class="breadcrumb" id="crumb">/</div>
      </div>
      <small class="note">Navegación por carpetas → Artículos → Lectura</small>
    </div>
    <div class="tabrow" id="tabs"></div>
  </div>
</header>

<main class="wrap">
  <div id="hero"></div>
  <div id="view"><p>Cargando…</p></div>
</main>

<footer>Didactic Eureka · interfaz bifásica (repo → representación)</footer>

<!-- PDF.js (render sin enlaces de descarga) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
<script>
/* ========= GitHub autodetección ========= */
const owner = location.hostname.split(".")[0];
const repo  = location.pathname.split("/").filter(Boolean)[0];
const API   = `https://api.github.com/repos/${owner}/${repo}/contents`;

const IMG_RE = /\.(jpg|jpeg|png|webp)$/i;

/* ========= Presentación de títulos =========
   - No inventa palabras: solo mejora lo legible.
*/
const DICT = [
  "filosofia","teologia","ciencia","antropologia","psicologia","linguistica","derecho","ensayos","yoga","teoretica",
  "introduccion","fundamentos","metodo","teoria","modelo","analisis","critica","conciencia","epica","logos","espiritu","santo","tomás","tomas"
];

function smartTitle(filenameOrFolder){
  let s = filenameOrFolder
    .replace(/:$/,"")
    .replace(/\.(pdf)$/i,"")
    .replace(/[_\-]+/g," ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .replace(/\s+/g," ")
    .trim();

  // Si quedó “pegado” (sin espacios), intentamos separar con diccionario básico sin inventar
  if(!s.includes(" ")){
    let x = s.toLowerCase();
    for(const w of DICT){
      x = x.replace(new RegExp(w,"g"), " " + w + " ");
    }
    x = x.replace(/\s+/g," ").trim();
    if(x.includes(" ")) s = x; // solo si mejoró
  }

  return s.toLowerCase().split(" ").map(w => w ? w[0].toUpperCase()+w.slice(1) : "").join(" ");
}

/* ========= Utilidades GitHub ========= */
async function fetchDir(path=""){
  const r = await fetch(path ? `${API}/${encodeURIComponent(path)}` : API);
  if(!r.ok) return [];
  return await r.json();
}

function joinPath(parts){ return parts.filter(Boolean).join("/"); }

function parseHash(){
  // Rutas:
  // #/                 → home
  // #/carpeta/sub/...   → carpeta
  // #/carpeta/.../file.pdf → artículo
  const raw = decodeURIComponent((location.hash || "#/").replace(/^#/, ""));
  const seg = raw.split("/").filter(Boolean);
  return seg;
}

function setCrumb(seg){
  document.getElementById("crumb").textContent = "/" + seg.join("/");
}

/* ========= Portada global (main.* en root) ========= */
async function renderHero(){
  const root = await fetchDir();
  const mainImg = root.find(x => x.type==="file" && /^main\.(jpg|jpeg|png|webp)$/i.test(x.name));
  const hero = document.getElementById("hero");
  if(mainImg){
    hero.innerHTML = `<div class="hero"><img src="${mainImg.download_url}" alt="Portada"><div class="cap">Portada</div></div>`;
  } else {
    hero.innerHTML = "";
  }
}

/* ========= Navegación: pestañas = carpetas en el nivel actual ========= */
async function renderTabs(currentPath){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";

  // Determina el contenedor actual (carpeta padre del nivel)
  const list = await fetchDir(currentPath);
  const dirs = list.filter(x => x.type==="dir");

  // Si no hay subcarpetas, mostramos pestañas del nivel raíz
  if(dirs.length === 0){
    const root = await fetchDir("");
    root.filter(x=>x.type==="dir").forEach(d=>{
      const b=document.createElement("button");
      b.textContent = smartTitle(d.name);
      b.onclick = () => { location.hash = "#/" + encodeURIComponent(d.name); };
      tabs.appendChild(b);
    });
    return;
  }

  dirs.forEach(d=>{
    const b = document.createElement("button");
    b.textContent = smartTitle(d.name);
    b.onclick = () => {
      const base = currentPath ? currentPath.split("/") : [];
      // Si currentPath es una carpeta, avanzamos dentro de ella añadiendo subcarpeta
      const seg = parseHash(); // ruta actual en hash
      const next = seg.concat([d.name]); // respeta nombres reales (incluye :)
      location.hash = "#/" + next.map(encodeURIComponent).join("/");
    };
    tabs.appendChild(b);
  });
}

function highlightTabs(){
  const seg = parseHash();
  const current = seg[seg.length-1] || "";
  document.querySelectorAll("#tabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.textContent === smartTitle(current));
  });
}

/* ========= Vista carpeta: lista subcarpetas + artículos ========= */
async function renderFolderView(seg){
  const view = document.getElementById("view");
  const path = joinPath(seg);
  const items = await fetchDir(path);

  const dirs = items.filter(x=>x.type==="dir");
  const pdfs = items.filter(x=>x.type==="file" && /\.pdf$/i.test(x.name));

  // Tarjetas: subcarpetas + artículos
  view.innerHTML = `
    <div class="panel">
      <h2>${seg.length ? smartTitle(seg[seg.length-1]) : "Inicio"}</h2>
      <div class="grid" id="grid"></div>
    </div>
  `;
  const grid = document.getElementById("grid");

  // Subcarpetas
  dirs.forEach(d=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h3>${smartTitle(d.name)}</h3><p>Subcategoría</p>`;
    const btn = document.createElement("button");
    btn.textContent = "Abrir";
    btn.onclick = () => {
      const next = seg.concat([d.name]);
      location.hash = "#/" + next.map(encodeURIComponent).join("/");
    };
    card.appendChild(btn);
    grid.appendChild(card);
  });

  // PDFs como artículos (abren página interna)
  for(const pdf of pdfs){
    const card = document.createElement("div");
    card.className = "card";

    const title = smartTitle(pdf.name);
    const meta = path ? (path + "/" + pdf.name) : pdf.name;

    // Buscar imagen por artículo:
    // 1) en misma carpeta con mismo nombre base
    // 2) en /main/ con mismo nombre base
    const base = pdf.name.replace(/\.pdf$/i,"").toLowerCase();
    let imgUrl = null;

    const localImg = items.find(f => f.type==="file" && IMG_RE.test(f.name) && f.name.replace(IMG_RE,"").toLowerCase()===base);
    if(localImg) imgUrl = localImg.download_url;

    if(!imgUrl){
      const mainDir = await fetchDir("main");
      const mainImg = mainDir.find(f => f.type==="file" && IMG_RE.test(f.name) && f.name.replace(IMG_RE,"").toLowerCase()===base);
      if(mainImg) imgUrl = mainImg.download_url;
    }

    card.innerHTML = `<h3>${title}</h3><p>${meta}</p>${imgUrl ? `<img class="thumb" src="${imgUrl}" alt="${title}">` : ""}`;
    const btn = document.createElement("button");
    btn.textContent = "Leer";
    btn.onclick = () => {
      const next = seg.concat([pdf.name]);
      location.hash = "#/" + next.map(encodeURIComponent).join("/");
    };
    card.appendChild(btn);
    grid.appendChild(card);
  }

  if(dirs.length===0 && pdfs.length===0){
    grid.innerHTML = `<div class="card"><h3>Vacío</h3><p>No hay subcarpetas ni PDFs aquí.</p></div>`;
  }
}

/* ========= Vista artículo (página interna HTML) ========= */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js";

async function renderArticleView(seg){
  const view = document.getElementById("view");
  const filename = seg[seg.length-1];
  const folderSeg = seg.slice(0, -1);
  const folderPath = joinPath(folderSeg);

  const files = await fetchDir(folderPath);
  const pdf = files.find(f => f.type==="file" && f.name === filename);
  if(!pdf){
    view.innerHTML = `<div class="panel"><h2>No encontrado</h2><p>No se pudo localizar el PDF.</p></div>`;
    return;
  }

  const title = smartTitle(pdf.name);

  // Imagen por artículo (mismo nombre base) en:
  // 1) misma carpeta
  // 2) /main/
  const base = pdf.name.replace(/\.pdf$/i,"").toLowerCase();
  let imgUrl = null;
  const localImg = files.find(f => f.type==="file" && IMG_RE.test(f.name) && f.name.replace(IMG_RE,"").toLowerCase()===base);
  if(localImg) imgUrl = localImg.download_url;
  if(!imgUrl){
    const mainDir = await fetchDir("main");
    const mainImg = mainDir.find(f => f.type==="file" && IMG_RE.test(f.name) && f.name.replace(IMG_RE,"").toLowerCase()===base);
    if(mainImg) imgUrl = mainImg.download_url;
  }

  view.innerHTML = `
    <div class="article">
      <h2>${title}</h2>
      <div class="meta">/${folderPath}/${pdf.name}</div>
      ${imgUrl ? `<img src="${imgUrl}" alt="${title}">` : ``}
      <div class="pdfwrap">
        <div class="pdfbar">
          <div class="left">
            <span>Lector (sin enlaces de descarga)</span>
            <span id="pageInfo">—</span>
          </div>
          <div class="right">
            <button id="prev">Anterior</button>
            <input id="pageNum" type="number" min="1" value="1">
            <button id="go">Ir</button>
            <button id="next">Siguiente</button>
          </div>
        </div>
        <div id="pdfPages"></div>
      </div>
    </div>
  `;

  const container = document.getElementById("pdfPages");
  container.innerHTML = "";

  // Render PDF con PDF.js (no hay <a href="pdf">)
  const loadingTask = pdfjsLib.getDocument(pdf.download_url);
  const doc = await loadingTask.promise;

  let currentPage = 1;
  const pageInfo = document.getElementById("pageInfo");
  const pageNum = document.getElementById("pageNum");

  async function renderPage(n){
    currentPage = Math.max(1, Math.min(doc.numPages, n));
    pageNum.value = currentPage;
    pageInfo.textContent = `Página ${currentPage} / ${doc.numPages}`;

    container.innerHTML = "";
    const page = await doc.getPage(currentPage);

    const viewport = page.getViewport({ scale: 1.25 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.height = viewport.height;
    canvas.width  = viewport.width;

    container.appendChild(canvas);
    await page.render({ canvasContext: ctx, viewport }).promise;
  }

  document.getElementById("prev").onclick = () => renderPage(currentPage - 1);
  document.getElementById("next").onclick = () => renderPage(currentPage + 1);
  document.getElementById("go").onclick   = () => renderPage(parseInt(pageNum.value || "1", 10));

  await renderPage(1);
}

/* ========= Router ========= */
async function route(){
  const seg = parseHash();
  setCrumb(seg);

  // Portada solo en raíz
  if(seg.length === 0){
    await renderHero();
  } else {
    document.getElementById("hero").innerHTML = "";
  }

  // Tabs: mostrar tabs del nivel actual (carpeta)
  // Si estamos en artículo, tabs del folder padre; si no, tabs del folder actual
  const isArticle = seg.length && /\.pdf$/i.test(seg[seg.length-1]);
  const tabFolder = isArticle ? joinPath(seg.slice(0,-1)) : joinPath(seg);
  await renderTabs(tabFolder);
  highlightTabs();

  if(isArticle){
    await renderArticleView(seg);
  } else {
    await renderFolderView(seg);
  }
}

window.addEventListener("hashchange", route);
route();
</script>
</body>
</html>
