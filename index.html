<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Didactic Eureka</title>

<style>
body{
  margin:0;
  font-family:Georgia,"Times New Roman",serif;
  background:#f6f5f2;
  color:#141414;
}
header{
  position:sticky;
  top:0;
  z-index:10;
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:16px;
}
h1{margin:0;font-size:24px}
nav{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
nav button{
  border:none;
  background:#eee;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
}
nav button.active{background:#ccc}
main{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.section-title{
  font-size:22px;
  margin:0 0 12px 0;
}
.item{
  padding:10px 0;
  border-bottom:1px solid #ddd;
}
.item button{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  text-align:left;
}
.item button:hover{color:#1f3cff}
.article iframe{
  width:100%;
  height:80vh;
  border:none;
  margin-top:12px;
}
.note{
  color:#666;
  font-size:14px;
  margin-top:14px;
}
</style>
</head>

<body>

<header>
  <h1>Didactic Eureka</h1>
  <nav id="nav"></nav>
</header>

<main id="content"></main>

<script>
/* ---------- UTILIDADES ---------- */
function titleize(str){
  return str
    .replace(/\.pdf$/i,"")
    .replace(/[_\-]+/g," ")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase()
    .replace(/\b\w/g,c=>c.toUpperCase());
}

const BASE = location.origin + location.pathname.replace(/\/[^\/]*$/,"");
let MANIFEST, PATH = [];

/* ---------- CONTADOR DE VISITAS ---------- */
const visits = Number(localStorage.getItem("visits")||0)+1;
localStorage.setItem("visits",visits);

/* ---------- PORTADA ---------- */
function showHome(){
  document.getElementById("nav").innerHTML="";
  document.getElementById("content").innerHTML = `
    <h2 class="section-title">Tomás Ignacio Lavados Sepúlveda</h2>
    <img src="https://avatars.githubusercontent.com/u/0"
         style="max-width:200px;border-radius:100px;margin-bottom:14px"
         onerror="this.style.display='none'">
    <p>
      Archivo bifásico autónomo de filosofía, ciencia y teología.
      El repositorio es la realidad; la interfaz es su representación.
    </p>
    <p class="note">Visitas locales: ${visits}</p>
  `;
}

/* ---------- NODO ACTUAL ---------- */
function currentNode(){
  let node = MANIFEST;
  for(const p of PATH){
    node = node.folders[p];
  }
  return node;
}

/* ---------- RENDER ---------- */
function render(){
  const nav = document.getElementById("nav");
  const content = document.getElementById("content");
  nav.innerHTML="";
  const node = currentNode();

  /* PESTAÑAS = carpetas */
  Object.keys(node.folders||{}).forEach(name=>{
    const b=document.createElement("button");
    b.textContent=titleize(name.replace(/:$/,""));
    b.onclick=()=>{
      PATH.push(name);
      render();
    };
    nav.appendChild(b);
  });

  content.innerHTML = `<h2 class="section-title">${
    PATH.length?titleize(PATH[PATH.length-1]):"Inicio"
  }</h2>`;

  /* ARTÍCULOS = PDFs */
  (node.files||[]).forEach(file=>{
    const d=document.createElement("div");
    d.className="item";
    const b=document.createElement("button");
    b.textContent=titleize(file);
    b.onclick=()=>openArticle(file);
    d.appendChild(b);
    content.appendChild(d);
  });

  if(PATH.length){
    const back=document.createElement("button");
    back.textContent="← Volver";
    back.onclick=()=>{
      PATH.pop();
      render();
    };
    nav.appendChild(back);
  }
}

/* ---------- ARTÍCULO ---------- */
function openArticle(file){
  const content=document.getElementById("content");
  const url=[...PATH,file].map(encodeURIComponent).join("/");
  content.innerHTML=`
    <h2 class="section-title">${titleize(file)}</h2>
    <iframe src="${url}"></iframe>
    <p class="note">Ruta: ${PATH.join(" / ")}</p>
  `;
}

/* ---------- CARGA ---------- */
fetch("manifest.json",{cache:"no-store"})
.then(r=>r.json())
.then(m=>{
  MANIFEST=m;
  showHome();
})
.catch(()=>{
  document.getElementById("content").innerHTML="Error al cargar manifest.json";
});
</script>

</body>
</html>
